<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="./styles/index.css">
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>
<body>
  <div id="app" v-cloak>
    <div class="container">
      <header id="header">
        <div class="search-input">
          <el-input
            v-model="search"
            placeholder="请输入图标名称"
            :autofocus="true">
          </el-input>
        </div>
        <el-button @click="searchIcon">搜索</el-button>
      </header>
      <!-- 搜索结果区域 -->
      <div class="search-result-container">
        <ul class="search-list" v-if="searchList.length > 0">
          <li class="search-item" v-for="item in searchList" :key="item.id">
            <div class="svg-block" v-html="item.svg"></div>
            <div class="checkbox-block">
              <el-checkbox v-model="item.checked" @change="checkedChange"></el-checkbox>
            </div>
          </li>
        </ul>
        <div class="empty-block" v-else>
          <el-empty description="描述文字"></el-empty>
        </div>
      </div>

      <!-- 已选择的图标展示区域 -->
      <div class="choosed-icon-block" v-if="choosedList.length > 0">
        <h3>已选择的图标列表:</h3>
        <ul class="choosed-icon-list">
          <li class="choosed-icon-item" v-for="(item, index) in choosedList" :key="item">
            <i class="el-icon-circle-close close-icon" @click="cancelChoose(item)"></i>
            <div class="icon" v-html="item.svg"></div>
            <!-- <div class="name">{{ item.en_name }}</div> -->
          </li>
        </ul>

        <!-- 按钮操作区域 -->
        <div class="btns-block" v-if="choosedList.length > 0">
          <div>
            <el-button @click="exportSvgSymbolsFile">导出symbolsjs</el-button>
          </div>
          <div>
            <el-button>导出svg</el-button>
          </div>
          <div>
            <el-button>重置</el-button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script type="text/javascript">

    const vscode = acquireVsCodeApi();

    const searchUrl = 'https://datav.iwencai.com/resource/api/icon/search';
    new Vue({
      el: '#app',
      data() {
        return {
          loading: false,
          search: '',
          searchList: [],
          choosedList: []
        }
      },
      watch: {
        searchList: {
          deep: true,
          handler: function(list) {
            // v-model对象的checked属性，如果checked属性值为false checkbox选项框无法再进行切换，因此需要删除
            if (Array.isArray(list) && list.length > 0) {
              list.forEach(item => {
                if (item['checked'] === false) {
                  item['checked'] = '';
                }
              })
            }
          }
        },
      },
      methods: {
        async searchIcon() {
          this.loading = true;
          const res = await axios.get(
            // TODO: 部门id可配置
            `${searchUrl}?project_id=0&page=1&name=${this.search}`
          );
          // 重置搜索列表
          this.searchList = [];
          if (res.data.status_code === 0) {
            this.searchList = res.data.data;
            if (Array.isArray(this.searchList) && this.searchList.length > 0) {
              // 将searchList和choosedList进行比对
              console.log(this.choosedList);
              this.searchList.forEach(item => {
                item['checked'] = this.choosedList.some(
                  chooseItem => chooseItem.id === item.id
                ) ? true : ''
              })
            }
          }
          this.loading = false;
        },
        exportSvgSymbolsFile() {
          vscode.postMessage({
            command: 'exportSvgSymbolsFile',
            data: [{
              name: 'eye1',
              svg: `<?xml version="1.0" encoding="UTF-8"?>
<svg width="25px" height="25px" viewBox="0 0 25 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <title>icon_list_edit</title>
    <g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="通用与功能图标--" transform="translate(-951.000000, -4682.000000)">
            <g id="icon_list_edit" transform="translate(951.377598, 4682.500000)">
                <rect id="透明底图" x="0" y="0" width="24" height="24"></rect>
                <g id="编组" transform="translate(1.000000, 0.000000)" fill="#000000" fill-rule="nonzero">
                    <path d="M9,1 C9.55228475,1 10,1.44771525 10,2 C10,2.51283584 9.61395981,2.93550716 9.11662113,2.99327227 L9,3 L2,3 L2,21 L20,21 L20,14 C20,13.4477153 20.4477153,13 21,13 C21.5128358,13 21.9355072,13.3860402 21.9932723,13.8833789 L22,14 L22,21 C22,22.0543618 21.1841222,22.9181651 20.1492623,22.9945143 L20,23 L2,23 C0.945638205,23 0.0818348781,22.1841222 0.00548573643,21.1492623 L0,21 L0,3 C0,1.9456382 0.815877791,1.08183488 1.85073766,1.00548574 L2,1 L9,1 Z M13.3583646,2.22970007 C15.1157239,0.472340754 17.9649663,0.472340754 19.7223256,2.22970007 C21.4247675,3.9321419 21.4779688,6.65929043 19.8819295,8.42577643 L19.7223256,8.5936611 L12.8568997,15.459087 L6.65893071,17.8843792 C5.63030833,18.2868836 4.47015085,17.7793147 4.06764645,16.7506924 C3.90721293,16.3406956 3.88715875,15.8909673 4.00748388,15.4710377 L4.06764645,15.293095 L6.49293866,9.09512599 L13.3583646,2.22970007 Z M18.3081121,3.64391363 C17.3742496,2.71005119 15.8853867,2.66944848 14.9032634,3.52210549 L14.7725781,3.64391363 L8.20379138,10.2113663 L5.93013201,16.0218937 L11.7379111,13.7483144 L18.3081121,7.17944753 C19.2027677,6.28479188 19.2775935,4.88075924 18.5325893,3.90089871 L18.4205831,3.76390496 L18.3081121,3.64391363 Z" id="形状"></path>
                </g>
            </g>
        </g>
    </g>
</svg>`
            },
            {
              name: 'dianzan1',
              svg: `<?xml version="1.0" encoding="UTF-8"?>
<svg width="24px" height="25px" viewBox="0 0 24 25" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <title>icon_list_forward</title>
    <g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="通用与功能图标--" transform="translate(-140.000000, -4682.000000)">
            <g id="icon_list_forward" transform="translate(140.000000, 4682.500000)">
                <rect id="透明底图" x="0" y="0" width="24" height="24"></rect>
                <path d="M7.75735931,22.6066017 C7.36683502,22.997126 6.73367004,22.997126 6.34314575,22.6066017 C5.98051605,22.243972 5.95461393,21.6721266 6.26543939,21.279609 L6.34314575,21.1923882 L15.5359754,11.9995585 L6.34314575,2.80761184 C5.98051605,2.44498215 5.95461393,1.87313675 6.26543939,1.4806191 L6.34314575,1.39339828 C6.70577545,1.03076858 7.27762084,1.00486646 7.6701385,1.31569192 L7.75735931,1.39339828 L17.6568542,11.2928932 C18.0194839,11.6555229 18.0453861,12.2273683 17.7345606,12.619886 L17.6568542,12.7071068 L7.75735931,22.6066017 Z" id="路径" fill="#000000" fill-rule="nonzero"></path>
            </g>
        </g>
    </g>
</svg>`
            }, {
              name: 'jiantou',
              svg: `<?xml version="1.0" encoding="UTF-8"?>
<svg width="25px" height="24px" viewBox="0 0 25 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <title>icon_list_Inlet</title>
    <g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="通用与功能图标--" transform="translate(-1157.000000, -4874.000000)">
            <g id="icon_list_Inlet" transform="translate(1157.377598, 4874.000000)">
                <rect id="透明底图" transform="translate(12.000000, 12.000000) scale(1, -1) rotate(-360.000000) translate(-12.000000, -12.000000) " x="0" y="0" width="24" height="24"></rect>
                <path d="M9.70710678,18.2928932 L15.2928932,12.7071068 C15.6834175,12.3165825 15.6834175,11.6834175 15.2928932,11.2928932 L9.70710678,5.70710678 C9.31658249,5.31658249 8.68341751,5.31658249 8.29289322,5.70710678 C8.10535684,5.89464316 8,6.14899707 8,6.41421356 L8,17.5857864 C8,18.1380712 8.44771525,18.5857864 9,18.5857864 C9.26521649,18.5857864 9.5195704,18.4804296 9.70710678,18.2928932 Z" id="路径" fill="#000000"></path>
            </g>
        </g>
    </g>
</svg>`
            }, {
              name: 'selected',
              svg: `<?xml version="1.0" encoding="UTF-8"?>
<svg width="12px" height="12px" viewBox="0 0 12 12" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <title>icon_list_multiSelect_small2</title>
    <g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="icon_list_multiSelect_small2">
            <rect id="矩形" x="0" y="0" width="12" height="12"></rect>
            <path d="M6,0 C9.3137085,0 12,2.6862915 12,6 C12,9.3137085 9.3137085,12 6,12 C2.6862915,12 0,9.3137085 0,6 C0,2.6862915 2.6862915,0 6,0 Z M8.87021451,3.63896346 C8.67534637,3.50396741 8.40592197,3.52325256 8.23235446,3.69682007 L8.23235446,3.69682007 L5.07369209,6.85686159 L3.76127953,5.58981658 L3.69100972,5.53320672 C3.49376238,5.40171142 3.22472525,5.42580388 3.05428547,5.60244147 C2.86254071,5.80115876 2.86819307,6.11769078 3.06691036,6.30943554 L3.06691036,6.30943554 L4.7324098,7.9164964 L4.80177072,7.97249348 C4.99642653,8.10286037 5.26176877,8.08161932 5.43314778,7.91024031 L5.43314778,7.91024031 L8.93946124,4.40392685 L8.99731785,4.33467781 C9.1323139,4.13980967 9.11302759,3.87038643 8.93946124,3.69682007 L8.93946124,3.69682007 Z" id="形状结合" fill="#FA3B32"></path>
        </g>
    </g>
</svg>`
            }]
          })
        },
        checkedChange(val) {
          // checked改变的时候比对一下
          const checkedList = this.searchList.filter(item => item.checked);
          const uncheckedList = this.searchList.filter(item => !item.checked);
          checkedList.forEach(item => {
            // 遍历当前搜索列表中的选中项，如果choosedList中没有则push进去
            if (!this.choosedList.some(chooseItem => chooseItem.id === item.id)) {
              this.choosedList.push(item);
            }
          })
          uncheckedList.forEach(item => {
            for (let i = 0; i < this.choosedList.length; i++) {
              if (this.choosedList[i].id === item.id) {
                this.choosedList.splice(i, 1);
              }
            }
          })
          // TODO: 将choosedList存入缓存
        },
        cancelChoose(item) {
          for (let i = 0; i < this.choosedList.length; i++) {
            if (item.id === this.choosedList[i].id) {
              this.choosedList.splice(i, 1);
            }
          }
          // 联动searchList, 删除对应项的checked属性
          if (Array.isArray(this.searchList) && this.searchList.length > 0) {
            for (let i = 0; i < this.searchList.length; i++) {
              if (this.searchList[i].id === item.id) {
                this.$set(this.searchList[i], 'checked', '');
              }
            }
          }
          // TODO: 将choosedList存入缓存
        }
      },
      mounted() {
        // TODO: 从缓存中取choosedList
        document.addEventListener('keydown', e => {
          if (e.keyCode === 13) {
            this.searchIcon();
          }
        })
      },
    })
  </script>
</body>
</html>